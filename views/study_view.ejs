<section>
  <h1><%= study.title %></h1>

  <% if (notice) { %><p class="notice"><%= notice %></p><% } %>
  <% if (error)  { %><p class="error"><%= error  %></p><% } %>

  <p><strong>Summary:</strong> <%= study.summary %></p>
  <p><strong>Purpose:</strong> <%= study.purpose %></p>
  <p><strong>Contact:</strong> <a href="mailto:<%= study.contactEmail %>"><%= study.contactEmail %></a></p>
  <p><strong>Default retention:</strong> <%= study.retentionDefaultDays ?? "—" %> days</p>

  <h2>Data categories</h2>

  <% if (user.role === 'participant') { %>
    <!-- Consent controls -->
    <form method="post" action="/s/<%= study.slug %>/consent">
      <ul>
        <% study.categories.forEach(c => {
             const prior = (latestConsent && latestConsent.choices.find(ch => ch.categoryId === c.id));
             const allowed = prior ? prior.allowed : false;
        %>
          <li class="box">
            <strong><%= c.name %></strong> <%= c.required ? "(required)" : "" %> — <%= c.description %>
            <div class="meta">Retention: <%= c.retentionDays ?? (study.retentionDefaultDays ?? "—") %> days</div>
            <div style="margin-top:.5rem;">
              <label>
                <input type="checkbox" name="cat_<%= c.id %>" <%= (c.required || allowed) ? 'checked' : '' %> <%= c.required ? 'disabled' : '' %> >
                Allow
              </label>
            </div>
          </li>
        <% }) %>
      </ul>
      <div style="display:flex; gap:.5rem; margin-top:.75rem; flex-wrap: wrap;">
        <button type="submit">Save choices</button>
        <a href="/s/<%= study.slug %>/receipt/latest" class="button"><strong>Receipt PDF</strong></a>
        <a href="/s/<%= study.slug %>/history" class="button">Consent history</a>
        <button formaction="/s/<%= study.slug %>/withdraw" formmethod="post" type="submit" class="danger">Withdraw (deny all)</button>
      </div>
      <p class="help">Required categories are always allowed. Saving creates a new version.</p>
    </form>

    <!-- Upload area -->
    <h2 style="margin-top:1.25rem;">Uploads</h2>
    <form method="post" action="/s/<%= study.slug %>/upload" enctype="multipart/form-data">
      <label>Choose category
        <select name="categoryId" required>
          <% study.categories.forEach(c => { %>
            <option value="<%= c.id %>"><%= c.name %> <%= c.required ? "(required)" : "" %></option>
          <% }) %>
        </select>
      </label>
      <label>File <input type="file" name="file" required></label>
      <button type="submit">Upload</button>
      <p class="help">Uploads are allowed only for categories you’ve allowed (required categories are always allowed). Max 10MB.</p>
    </form>

    <% if (myUploads && myUploads.length) { %>
      <table>
        <thead><tr><th>When</th><th>Category</th><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody>
        <% myUploads.forEach(u => { %>
          <tr>
            <td><%= new Date(u.createdAt).toLocaleString() %></td>
            <td><%= u.category.name %></td>
            <td><%= u.originalName %></td>
            <td><%= (u.sizeBytes/1024/1024).toFixed(2) %> MB</td>
            <td>
              <a href="/uploads/<%= u.id %>/download">Download</a>
              <% if (!u.deletedAt) { %>
                &nbsp;|&nbsp;
                <form method="post" action="/uploads/<%= u.id %>/delete" style="display:inline;">
                  <button class="danger">Delete</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
        </tbody>
      </table>
    <% } %>

    <% if (latestConsent) { %>
      <h3>Latest saved choices (v<%= latestConsent.version %>)</h3>
      <ul>
        <% latestConsent.choices.forEach(ch => {
             const cat = study.categories.find(c => c.id === ch.categoryId);
        %>
          <li><strong><%= cat?.name || ch.categoryId %>:</strong> <%= ch.allowed ? 'Allowed' : 'Denied' %></li>
        <% }) %>
      </ul>
      <p class="meta">Receipt hash: <code><%= latestConsent.receiptHash %></code></p>
    <% } %>

  <% } else { %>
    <!-- Researcher read-only view + Excel export only -->
    <ul>
      <% study.categories.forEach(c => { %>
        <li class="box">
          <strong><%= c.name %></strong> <%= c.required ? "(required)" : "" %> — <%= c.description %>
          <div class="meta">Retention: <%= c.retentionDays ?? (study.retentionDefaultDays ?? "—") %> days</div>
        </li>
      <% }) %>
    </ul>
    <p class="help"><em>Participants see consent and uploads here.</em></p>
    <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap: wrap;">
      <a class="button" href="/researcher/studies/<%= study.slug %>/export.xlsx"><strong>Export Excel</strong></a>
    </div>
  <% } %>

  <p style="margin-top:1rem;">
    <a href="<%= (user && user.role === 'researcher') ? '/researcher' : '/participant' %>">
      ← Back to <%= (user && user.role === 'researcher') ? 'your studies' : 'all studies' %>
    </a>
  </p>
</section>
