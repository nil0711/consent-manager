<section class="section">
  <div class="container-page grid gap-6">

    <div class="card">
      <div class="card-header">
        <h1 class="text-lg font-semibold">Edit: <%= study.title %></h1>
        <a class="btn" href="/researcher">Back</a>
      </div>

      <% if (typeof error === 'string' && error) { %>
        <div class="error mb-3"><%= error %></div>
      <% } %>

      <% const c = (Array.isArray(cats) ? cats : []).slice(0,3); %>

      <form method="post" action="/researcher/studies/<%= study.slug %>/edit" class="grid gap-5">

        <!-- Basics -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="grid gap-3">
            <label class="label">Title
              <input class="input" name="title" required
                     value="<%= study.title %>">
            </label>

            <label class="label">Purpose
              <textarea class="input" name="purpose" rows="3" required><%= study.purpose %></textarea>
            </label>
          </div>

          <div class="grid gap-3">
            <label class="label">Summary
              <textarea class="input" name="summary" rows="3" required><%= study.summary %></textarea>
            </label>

            <div class="grid md:grid-cols-2 gap-3">
              <label class="label">Contact email
                <input class="input" type="email" name="contactEmail" required
                       value="<%= study.contactEmail %>">
              </label>
              <label class="label">Default retention days (optional)
                <input class="input" type="number" min="0" name="retentionDays"
                       value="<%= (typeof study.retentionDefaultDays === 'number' ? study.retentionDefaultDays : '') %>">
              </label>
            </div>
            <p class="help -mt-2">Uploads without a category override will be purged after this many days.</p>
          </div>
        </div>

        <!-- Status & join code -->
        <div class="grid md:grid-cols-[1fr,1fr] gap-4">
          <label class="label">Status
            <select class="input" name="status" id="status-select">
              <option value="public" <%= study.status === 'public' ? 'selected' : '' %>>public</option>
              <option value="invite" <%= study.status === 'invite' ? 'selected' : '' %>>invite</option>
              <option value="draft"  <%= study.status === 'draft'  ? 'selected' : '' %>>draft</option>
            </select>
          </label>

          <div id="join-wrapper">
            <label class="label">Join code (invite mode)
              <input class="input" name="joinCode"
                     placeholder="leave blank to keep current / auto-generate"
                     value="<%= (study.joinCode || '') %>">
            </label>
          </div>
        </div>

        <!-- Categories -->
        <div class="card">
          <div class="card-header">
            <h2 class="text-lg font-semibold">Categories</h2>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <!-- Cat 1 -->
            <div class="border border-[var(--line)] rounded-xl p-3 bg-white grid gap-3">
              <div class="font-medium">Category 1</div>
              <input type="hidden" name="c1_id" value="<%= c[0]?.id || '' %>">
              <label class="label">Name
                <input class="input" name="c1_name" required value="<%= c[0]?.name || '' %>">
              </label>
              <label class="label">Description
                <input class="input" name="c1_desc" value="<%= c[0]?.description || '' %>">
              </label>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="c1_req" name="c1_req" <%= (c[0]?.required ? 'checked' : '') %> >
                <label for="c1_req">Required</label>
              </div>
              <label class="label">Retention days (optional)
                <input class="input" type="number" min="0" name="c1_ret"
                       value="<%= (typeof c[0]?.retentionDays === 'number' ? c[0].retentionDays : '') %>">
              </label>
            </div>

            <!-- Cat 2 -->
            <div class="border border-[var(--line)] rounded-xl p-3 bg-white grid gap-3">
              <div class="font-medium">Category 2</div>
              <input type="hidden" name="c2_id" value="<%= c[1]?.id || '' %>">
              <label class="label">Name
                <input class="input" name="c2_name" required value="<%= c[1]?.name || '' %>">
              </label>
              <label class="label">Description
                <input class="input" name="c2_desc" value="<%= c[1]?.description || '' %>">
              </label>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="c2_req" name="c2_req" <%= (c[1]?.required ? 'checked' : '') %> >
                <label for="c2_req">Required</label>
              </div>
              <label class="label">Retention days (optional)
                <input class="input" type="number" min="0" name="c2_ret"
                       value="<%= (typeof c[1]?.retentionDays === 'number' ? c[1].retentionDays : '') %>">
              </label>
            </div>

            <!-- Cat 3 -->
            <div class="border border-[var(--line)] rounded-xl p-3 bg-white grid gap-3">
              <div class="font-medium">Category 3</div>
              <input type="hidden" name="c3_id" value="<%= c[2]?.id || '' %>">
              <label class="label">Name
                <input class="input" name="c3_name" required value="<%= c[2]?.name || '' %>">
              </label>
              <label class="label">Description
                <input class="input" name="c3_desc" value="<%= c[2]?.description || '' %>">
              </label>
              <div class="flex items-center gap-2">
                <input type="checkbox" id="c3_req" name="c3_req" <%= (c[2]?.required ? 'checked' : '') %> >
                <label for="c3_req">Required</label>
              </div>
              <label class="label">Retention days (optional)
                <input class="input" type="number" min="0" name="c3_ret"
                       value="<%= (typeof c[2]?.retentionDays === 'number' ? c[2].retentionDays : '') %>">
              </label>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-primary" type="submit">Save changes</button>
          <a class="btn" href="/researcher">Cancel</a>
        </div>
      </form>
    </div>

    <!-- Optional Danger zone (only shows if you wired the delete route) -->
    <div class="card" style="border-color: var(--danger);">
      <div class="card-header">
        <h2 class="text-lg font-semibold">Danger zone</h2>
      </div>
      <p class="help">Deleting this study removes enrollments and prevents further access.</p>
      <form method="post" action="/researcher/studies/<%= study.slug %>/delete"
            onsubmit="return confirm('Delete this study? This action cannot be undone.');">
        <button class="btn danger">Delete study</button>
      </form>
    </div>
  </div>

  <script>
    (function(){
      var sel = document.getElementById('status-select');
      var wrap = document.getElementById('join-wrapper');
      function toggleJoin(){ wrap.style.display = sel.value === 'invite' ? '' : 'none'; }
      toggleJoin();
      sel.addEventListener('change', toggleJoin, { passive: true });
    })();
  </script>
</section>
